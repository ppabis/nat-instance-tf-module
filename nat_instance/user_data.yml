#cloud-config
cloud_final_modules:
  - [scripts-user, always]

runcmd:
  - yum update -y
  - yum install iptables-services -y
  - echo "net.ipv4.ip_forward=1" >> /etc/sysctl.d/90-nat.conf
  - sysctl --system
  # Find the private interface name
  - for i in {1..10}; do
  -   ETH1=$(ip -4 addr show device-number-1 | grep -oP 'ens[0-9]+' | head -n1)
  -   '[[ -n "$ETH1" ]] && break'
  -   sleep 3
  - done
  # Select public interface
  - ETH0=$(ip -4 addr show device-number-0 | grep -oP 'ens[0-9]+' | head -n1)
  - 'echo "Devices: public: $ETH0 and private: $ETH1"'
  - iptables -F
  - iptables -t nat -F
  - iptables -P FORWARD ACCEPT
  - iptables -t nat -A POSTROUTING -o $ETH0 -j MASQUERADE
  - iptables -A FORWARD -i $ETH0 -o $ETH1 -m state --state RELATED,ESTABLISHED -j ACCEPT
  - iptables -A FORWARD -i $ETH1 -o $ETH0 -j ACCEPT
  - systemctl enable iptables
  - service iptables save